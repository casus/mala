<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>External modules &mdash; Materials Learning Algorithms (MALA)  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/mala_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using MALA on HPC systems" href="on_cluster.html" />
    <link rel="prev" title="Installation of MALA" href="README.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/mala_horizontal_white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../installation.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="README.html">Installation of MALA</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">External modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#quantum-espresso-total-energy-module">Quantum ESPRESSO (total energy module)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#build-quantum-espresso">Build Quantum ESPRESSO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-and-test-the-python-extension-module">Use and test the Python extension module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#lammps-descriptor-calculation">LAMMPS (descriptor calculation)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="on_cluster.html">Using MALA on HPC systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="tested_systems.html">Successfully tested on</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTE.html">Contributing to MALA</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Materials Learning Algorithms (MALA)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../installation.html">Installation</a> &raquo;</li>
      <li>External modules</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com//mala-project/mala/blob/develop/docs/source/install/external_modules.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="external-modules">
<h1>External modules<a class="headerlink" href="#external-modules" title="Permalink to this headline"></a></h1>
<p>MALA can be coupled to external libraries for data pre- and postprocesing.
The DFT code Quantum ESPRESSO is used for the calculation of the density
contributions to the total energy, while the LAMMPS code is used to calculate
SNAP descriptors on the real space grid of a simulation cell, either for
training or inference.</p>
<div class="section" id="quantum-espresso-total-energy-module">
<h2>Quantum ESPRESSO (total energy module)<a class="headerlink" href="#quantum-espresso-total-energy-module" title="Permalink to this headline"></a></h2>
<p>To run the total energy module, you need a full Quantum ESPRESSO (version
6.4.1.) and install the python bindings for it.</p>
<div class="section" id="build-quantum-espresso">
<h3>Build Quantum ESPRESSO<a class="headerlink" href="#build-quantum-espresso" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Clone QE source code: <code class="docutils literal notranslate"><span class="pre">git&#64;gitlab.com:QEF/q-e.git</span></code></p></li>
<li><p>Chage into the <code class="docutils literal notranslate"><span class="pre">q-e</span></code> directory and check out the correct branch
(the total energy module is based on version 6.4.1): <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">checkout</span> <span class="pre">qe-6.4.1</span></code></p></li>
<li><p>Make sure you have an (MPI-aware) F90 compiler such as <code class="docutils literal notranslate"><span class="pre">mpif90</span></code> (e.g.
Debian-ish machine: <code class="docutils literal notranslate"><span class="pre">apt</span> <span class="pre">install</span> <span class="pre">openmpi-bin</span></code>, on an HPC cluster something
like <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">openmpi</span> <span class="pre">gcc</span></code>). Make sure to use the same compiler
for QE and the extension (<code class="docutils literal notranslate"><span class="pre">--f90exec=</span></code> in <code class="docutils literal notranslate"><span class="pre">build_total_energy_energy_module.sh</span></code>).</p></li>
<li><p>We assume that QE’s <code class="docutils literal notranslate"><span class="pre">configure</span></code> script will find your system libs, e.g. use
<code class="docutils literal notranslate"><span class="pre">-lblas</span></code>, <code class="docutils literal notranslate"><span class="pre">-llapack</span></code> and <code class="docutils literal notranslate"><span class="pre">-lfftw3</span></code>. We use those by default in
<code class="docutils literal notranslate"><span class="pre">build_total_energy_energy_module.sh</span></code>. If you have, say, the MKL library,
you may see <code class="docutils literal notranslate"><span class="pre">configure</span></code> use something like <code class="docutils literal notranslate"><span class="pre">-lmkl_intel_lp64</span> <span class="pre">-lmkl_sequential</span> <span class="pre">-lmkl_core</span></code>
when building QE. In this case you have to modify
<code class="docutils literal notranslate"><span class="pre">build_total_energy_energy_module.sh</span></code> to use the same libraries!</p>
<ul>
<li><p>GNU compiler specific: we use <code class="docutils literal notranslate"><span class="pre">-fallow-argument-mismatch</span></code></p></li>
</ul>
</li>
<li><p>Change to the <code class="docutils literal notranslate"><span class="pre">external_modules/total_energy_module</span></code> directory of the
MALA repository</p></li>
<li><p>Run the script <code class="docutils literal notranslate"><span class="pre">prepare_qe.sh</span> <span class="pre">/path/to/your/q-e</span></code> with <code class="docutils literal notranslate"><span class="pre">/path/to/your/qe</span></code>
being the path to the <code class="docutils literal notranslate"><span class="pre">q-e</span></code> directory</p></li>
<li><p>Change to the <code class="docutils literal notranslate"><span class="pre">q-e</span></code> directory</p>
<ul>
<li><p>If you already have a build of QE, go into the <code class="docutils literal notranslate"><span class="pre">q-e</span></code> folder and run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">veryclean</span></code>.</p></li>
</ul>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">./configure</span> <span class="pre">CFLAGS=&quot;-fPIC&quot;</span> <span class="pre">CPPFLAGS=&quot;-fPIC&quot;</span> <span class="pre">FFLAGS=&quot;-fPIC</span> <span class="pre">-fallow-argument-mismatch&quot;</span></code></p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code> (use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-j&lt;your</span> <span class="pre">number</span> <span class="pre">of</span> <span class="pre">cores&gt;</span> <span class="pre">all</span></code> for a faster
compilation process).</p></li>
<li><p>Change back to the  <code class="docutils literal notranslate"><span class="pre">external_modules/total_energy_module</span></code> directory of the
MALA repository</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">build_total_energy_energy_module.sh</span> <span class="pre">/path/to/your/q-e</span></code>.</p>
<ul>
<li><p>If the build is successful, a file named something like
<code class="docutils literal notranslate"><span class="pre">total_energy.cpython-39m-x86_64-linux-gnu.so</span></code> will be generated. This is
the Python extension module.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="use-and-test-the-python-extension-module">
<h3>Use and test the Python extension module<a class="headerlink" href="#use-and-test-the-python-extension-module" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">external_modules/total_energy_module</span></code> directory to your python
path, e.g. via <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">PYTHONPATH=/path/to/mala/external_modules/total_energy_module:$PYTHONPATH</span></code></p></li>
<li><p>Now you can use <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">total_energy</span></code> to access the total energy module</p></li>
<li><p>The MALA test suite will test the total energy module</p></li>
</ul>
</div>
</div>
<div class="section" id="lammps-descriptor-calculation">
<h2>LAMMPS (descriptor calculation)<a class="headerlink" href="#lammps-descriptor-calculation" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Checkout <a class="reference external" href="https://github.com/athomps/lammps/tree/mala">https://github.com/athomps/lammps/tree/mala</a></p></li>
<li><p>Make sure the <code class="docutils literal notranslate"><span class="pre">mala</span></code> tree is checked out locally via <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">branch</span></code>!</p></li>
<li><p>Compile the LAMMPS shared library with the SNAP package installed</p>
<ul>
<li><p>cd into <code class="docutils literal notranslate"><span class="pre">/path/to/lammps/src</span></code> folder of LAMMPS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">yes-ml-snap</span></code></p></li>
<li><p>(optional: check with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">ps</span></code> that <code class="docutils literal notranslate"><span class="pre">ml-snap</span></code> was correctly added)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">mode=shlib</span> <span class="pre">mpi</span></code></p></li>
</ul>
</li>
<li><p>Make the LAMMPS library visible via <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">install.py</span> <span class="pre">-p</span> <span class="pre">lammps</span> <span class="pre">-l</span> <span class="pre">../src/liblammps.so</span></code></p></li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="README.html" class="btn btn-neutral float-left" title="Installation of MALA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="on_cluster.html" class="btn btn-neutral float-right" title="Using MALA on HPC systems" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software. Attila Cangi, J. Austin Ellis, Lenz Fiedler, Daniel Kotik, Normand Modine, Sivasankaran Rajamanickam, Steve Schmerler, Aidan Thompson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>