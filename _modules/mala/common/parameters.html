<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mala.common.parameters &mdash; Materials Learning Algorithms (MALA)  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=33f2f6c7" />

  
    <link rel="shortcut icon" href="../../../_static/mala_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/mala_horizontal_white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_usage.html">Getting started with MALA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced_usage.html">Advanced options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing MALA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CONTRIBUTE.html">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Materials Learning Algorithms (MALA)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mala.common.parameters</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mala.common.parameters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Collection of all parameter related classes and functions.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.distributed</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dist</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mala.common.parallelizer</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">printout</span><span class="p">,</span>
    <span class="n">set_ddp_status</span><span class="p">,</span>
    <span class="n">set_mpi_status</span><span class="p">,</span>
    <span class="n">get_rank</span><span class="p">,</span>
    <span class="n">get_local_rank</span><span class="p">,</span>
    <span class="n">set_current_verbosity</span><span class="p">,</span>
    <span class="n">parallel_warn</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mala.common.json_serializable</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONSerializable</span>

<span class="n">DEFAULT_NP_DATA_DTYPE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>


<div class="viewcode-block" id="ParametersBase">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersBase">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersBase</span><span class="p">(</span><span class="n">JSONSerializable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base parameter class for MALA.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ddp&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;mpi&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;device&quot;</span><span class="p">:</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;openpmd_configuration&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;openpmd_granularity&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;lammps&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;atomic_density_formula&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="ParametersBase.show">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersBase.show">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print name and values of all attributes of this object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indent : string</span>
<span class="sd">            The indent used in the list with which the parameter</span>
<span class="sd">            shows itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;_configuration&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                    <span class="n">printout</span><span class="p">(</span>
                        <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span>
                        <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printout</span><span class="p">(</span>
                        <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span>
                        <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_gpu</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new GPU setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_gpu : bool</span>
<span class="sd">            New GPU setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;gpu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_gpu</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ddp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new DDP setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_ddp : bool</span>
<span class="sd">            New DDP setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;ddp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ddp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_mpi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new MPI setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_mpi : bool</span>
<span class="sd">            New MPI setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_mpi</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new device setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_device : str</span>
<span class="sd">            New device setting. Can be &quot;cpu&quot; or &quot;cuda:x&quot;, where x is some</span>
<span class="sd">            integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_device</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_openpmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new openPMD configuration to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_openpmd : dict</span>
<span class="sd">            New openPMD configuration, which is a dict containing different</span>
<span class="sd">            settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;openpmd_configuration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_openpmd</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_granularity</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new openPMD granularity to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_granularity : int</span>
<span class="sd">            New openPMD granularity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;openpmd_granularity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_granularity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_lammps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new LAMMPS setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_lammps : bool</span>
<span class="sd">            New LAMMPS setting. Setting here means whether LAMMPS</span>
<span class="sd">            will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;lammps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_lammps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_atomic_density_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_atomic_density_formula</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new atomic density formula setting to parameter subclasses.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_atomic_density_formula : bool</span>
<span class="sd">            New atomic density formula setting, i.e., whether to use this</span>
<span class="sd">            option.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;atomic_density_formula&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">new_atomic_density_formula</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_member_to_json</span><span class="p">(</span><span class="n">member</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a member to a JSON serializable object.</span>

<span class="sd">        For a class that inherits from JSONSerializable, this will call the</span>
<span class="sd">        to_json method of that class. Otherwise, it will return the member</span>
<span class="sd">        itself (for basic data types)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        member : any, JSONSerializable</span>
<span class="sd">            Member to be converted to JSON serializable object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        json_serializable : any</span>
<span class="sd">            JSON serializable object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">member</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">member</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>

<div class="viewcode-block" id="ParametersBase.to_json">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersBase.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this object to a dictionary that can be saved in a JSON file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        json_dict : dict</span>
<span class="sd">            The object as dictionary for export to JSON.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="c1"># Filter out all private members, builtins, etc.</span>
            <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>

                <span class="c1"># If we deal with a list or a dict,</span>
                <span class="c1"># we have to sanitize treat all members of that list</span>
                <span class="c1"># or dict separately.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_member</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">_member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_member_to_json</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_member</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_member</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_member</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_member_to_json</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_member</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_member_to_json</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">json_dict</span><span class="p">[</span><span class="s2">&quot;_parameters_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">return</span> <span class="n">json_dict</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_json_to_member</span><span class="p">(</span><span class="n">json_value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a JSON dictionary to a member.</span>

<span class="sd">        This function is used to convert a JSON dictionary to a member of this</span>
<span class="sd">        class. If the member is a JSONSerializable object, it will call the</span>
<span class="sd">        from_json method of that class. Otherwise, it will return the member</span>
<span class="sd">        directly (for basic data types)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_value : any</span>
<span class="sd">            JSON value/dictionary entry to be converted to a member.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        member : any</span>
<span class="sd">            Loaded member of this class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">json_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">json_value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># We have found ourselves an object!</span>
                <span class="c1"># We create it and give it the JSON dict, hoping it can handle</span>
                <span class="c1"># it. If not, then the implementation of that class has to</span>
                <span class="c1"># be adjusted.</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;mala&quot;</span><span class="p">)</span>
                <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">json_value</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">])</span>
                <span class="n">new_object</span> <span class="o">=</span> <span class="n">class_</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_value</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">new_object</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If it is not an elementary builtin type AND not an object</span>
                <span class="c1"># dictionary, something is definitely off.</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Could not decode JSON file, error in&quot;</span><span class="p">,</span> <span class="n">json_value</span>
                <span class="p">)</span>

<div class="viewcode-block" id="ParametersBase.from_json">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersBase.from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read parameters from a dictionary saved in a JSON file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_dict : dict</span>
<span class="sd">            A dictionary containing all attributes, properties, etc. as saved</span>
<span class="sd">            in the json file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        deserialized_object : JSONSerializable</span>
<span class="sd">            The object as read from the JSON file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deserialized_object</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">:</span>
            <span class="c1"># Filter out all private members, builtins, etc.</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;_parameters_type&quot;</span><span class="p">:</span>

                <span class="c1"># If we deal with a list or a dict,</span>
                <span class="c1"># we have to sanitize treat all members of that list</span>
                <span class="c1"># or dict separately.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_member</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">_member</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">deserialized_object</span><span class="o">.</span><span class="n">_json_to_member</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">deserialized_object</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">_member</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">deserialized_object</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_member</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_member</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">deserialized_object</span><span class="o">.</span><span class="n">_json_to_member</span><span class="p">(</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
                            <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">deserialized_object</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">_member</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">deserialized_object</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">deserialized_object</span><span class="p">,</span>
                        <span class="n">key</span><span class="p">,</span>
                        <span class="n">deserialized_object</span><span class="o">.</span><span class="n">_json_to_member</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">deserialized_object</span></div>
</div>



<div class="viewcode-block" id="ParametersNetwork">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersNetwork">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersNetwork</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters necessary for constructing a neural network.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    nn_type : string</span>
<span class="sd">        Type of the neural network that will be used. Currently supported are</span>

<span class="sd">            - &quot;feed_forward&quot; (default)</span>
<span class="sd">            - &quot;transformer&quot;</span>
<span class="sd">            - &quot;lstm&quot;</span>
<span class="sd">            - &quot;gru&quot;</span>

<span class="sd">    layer_sizes : list</span>
<span class="sd">        A list of integers detailing the sizes of the layer of the neural</span>
<span class="sd">        network. Please note that the input layer is included therein.</span>
<span class="sd">        Default: [10,10,0]</span>

<span class="sd">    layer_activations : list</span>
<span class="sd">        A list of strings detailing the activation functions to be used</span>
<span class="sd">        by the neural network. If the dimension of layer_activations is</span>
<span class="sd">        smaller than the dimension of layer_sizes-1, than the first entry</span>
<span class="sd">        is used for all layers.</span>
<span class="sd">        Currently supported activation functions are:</span>

<span class="sd">            - Sigmoid (default)</span>
<span class="sd">            - ReLU</span>
<span class="sd">            - LeakyReLU</span>

<span class="sd">    loss_function_type : string</span>
<span class="sd">        Loss function for the neural network</span>
<span class="sd">        Currently supported loss functions include:</span>

<span class="sd">            - mse (Mean squared error; default)</span>

<span class="sd">    no_hidden_state : bool</span>
<span class="sd">        If True hidden and cell state is assigned to zeros for LSTM Network.</span>
<span class="sd">        false will keep the hidden state active</span>
<span class="sd">        Default: False</span>

<span class="sd">    bidirection : bool</span>
<span class="sd">        Sets lstm network size based on bidirectional or just one direction</span>
<span class="sd">        Default: False</span>

<span class="sd">    num_hidden_layers : int</span>
<span class="sd">        Number of hidden layers to be used in lstm or gru or transformer nets</span>
<span class="sd">        Default: None</span>

<span class="sd">    num_heads : int</span>
<span class="sd">        Number of heads to be used in Multi head attention network</span>
<span class="sd">        This should be a divisor of input dimension</span>
<span class="sd">        Default: None</span>

<span class="sd">    dropout : float</span>
<span class="sd">        Dropout rate for positional encoding in transformer.</span>
<span class="sd">        Default: 0.1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersNetwork</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_type</span> <span class="o">=</span> <span class="s2">&quot;feed-forward&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer_activations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sigmoid&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_function_type</span> <span class="o">=</span> <span class="s2">&quot;mse&quot;</span>

        <span class="c1"># for LSTM/Gru</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_hidden_state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bidirection</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># for LSTM/Gru + Transformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_hidden_layers</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># for transformer net</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_heads</span> <span class="o">=</span> <span class="mi">10</span></div>



<div class="viewcode-block" id="ParametersDescriptors">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersDescriptors">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersDescriptors</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters necessary for calculating/parsing input descriptors.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    descriptor_type : string</span>
<span class="sd">        Type of descriptors that is used to represent the atomic fingerprint.</span>
<span class="sd">        Supported:</span>

<span class="sd">            - &#39;Bispectrum&#39;: Bispectrum descriptors (formerly called &#39;SNAP&#39;).</span>
<span class="sd">            - &#39;Atomic Density&#39;: Atomic density, calculated via Gaussian</span>
<span class="sd">                                descriptors.</span>

<span class="sd">    bispectrum_twojmax : int</span>
<span class="sd">        Bispectrum calculation: 2*jmax-parameter used for calculation of</span>
<span class="sd">        bispectrum descriptors. Default value for jmax is 5, so default value</span>
<span class="sd">        for twojmax is 10.</span>

<span class="sd">    descriptors_contain_xyz : bool</span>
<span class="sd">        Legacy option. If True, it is assumed that the first three entries of</span>
<span class="sd">        the descriptor vector are the xyz coordinates and they are cut from the</span>
<span class="sd">        descriptor vector. If False, no such cutting is peformed.</span>

<span class="sd">    atomic_density_sigma : float</span>
<span class="sd">        Sigma (=width) used for the calculation of the Gaussian descriptors.</span>
<span class="sd">        Explicitly setting this value is discouraged if the atomic density is</span>
<span class="sd">        used only during the total energy calculation and, e.g., bispectrum</span>
<span class="sd">        descriptors are used for models. In this case, the width will</span>
<span class="sd">        automatically be set correctly during inference based on model</span>
<span class="sd">        parameters. This parameter mainly exists for debugging purposes.</span>
<span class="sd">        If the atomic density is instead used for model training itself, this</span>
<span class="sd">        parameter needs to be set.</span>

<span class="sd">    atomic_density_cutoff : float</span>
<span class="sd">        Cutoff radius used for atomic density calculation. Explicitly setting</span>
<span class="sd">        this value is discouraged if the atomic density is used only during the</span>
<span class="sd">        total energy calculation and, e.g., bispectrum descriptors are used</span>
<span class="sd">        for models. In this case, the cutoff will automatically be set</span>
<span class="sd">        correctly during inference based on model parameters. This parameter</span>
<span class="sd">        mainly exists for debugging purposes. If the atomic density is instead</span>
<span class="sd">        used for model training itself, this parameter needs to be set.</span>

<span class="sd">    custom_lammps_compute_file : str</span>
<span class="sd">        Path to a LAMMPS compute file for the descriptor calculation.</span>
<span class="sd">        MALA has its own collection of compute files which are</span>
<span class="sd">        used by default, i.e., when this string is empty.</span>
<span class="sd">        Setting this parameter is thus not necessarys for</span>
<span class="sd">        model training and inference, and it exists mainly for debugging</span>
<span class="sd">        purposes.</span>

<span class="sd">    minterpy_cutoff_cube_size : float</span>
<span class="sd">        WILL BE DEPRECATED IN MALA v1.4.0 - size of cube for minterpy</span>
<span class="sd">        descriptor calculation.</span>

<span class="sd">    minterpy_lp_norm : int</span>
<span class="sd">        WILL BE DEPRECATED IN MALA v1.4.0 - LP norm for minterpy</span>
<span class="sd">        descriptor calculation.</span>

<span class="sd">    minterpy_point_list : list</span>
<span class="sd">        WILL BE DEPRECATED IN MALA v1.4.0 - list of points for minterpy</span>
<span class="sd">        descriptor calculation.</span>

<span class="sd">    minterpy_polynomial_degree : int</span>
<span class="sd">        WILL BE DEPRECATED IN MALA v1.4.0 - polynomial degree for minterpy</span>
<span class="sd">        descriptor calculation.</span>

<span class="sd">    ace_included_expansion_ranks : list</span>
<span class="sd">        List of all included expansion ranks for the ACE descriptors.</span>
<span class="sd">        These expansion ranks correspond to the many body order in the</span>
<span class="sd">        expansion of the atomic energy in many body terms. The list does</span>
<span class="sd">        can exclude terms, i.e., [1,2,4] is a valid option.</span>
<span class="sd">        Lengths have to be consistent between ace_included_expansion_ranks,</span>
<span class="sd">        ace_maximum_n_per_rank, ace_maximum_l_per_rank and</span>
<span class="sd">        ace_minimum_l_per_rank.</span>

<span class="sd">    ace_maximum_n_per_rank  : list</span>
<span class="sd">        Maximum n for each expansion rank in the ACE descriptors. These</span>
<span class="sd">        n correspond to the n starting from equation 27 in the original</span>
<span class="sd">        ACE paper (doi.org/10.1103/PhysRevB.99.014104)</span>
<span class="sd">        Lengths have to be consistent between ace_included_expansion_ranks,</span>
<span class="sd">        ace_maximum_n_per_rank, ace_maximum_l_per_rank and</span>
<span class="sd">        ace_minimum_l_per_rank.</span>

<span class="sd">    ace_maximum_l_per_rank : list</span>
<span class="sd">        Maximum l for each expansion rank in the ACE descriptors. These</span>
<span class="sd">        n correspond to the n starting from equation 27 in the original</span>
<span class="sd">        ACE paper (doi.org/10.1103/PhysRevB.99.014104).</span>
<span class="sd">        Lengths have to be consistent between ace_included_expansion_ranks,</span>
<span class="sd">        ace_maximum_n_per_rank, ace_maximum_l_per_rank and</span>
<span class="sd">        ace_minimum_l_per_rank.</span>

<span class="sd">    ace_minimum_l_per_rank : list</span>
<span class="sd">        Minimum l for each expansion rank in the ACE descriptors. These</span>
<span class="sd">        n correspond to the n starting from equation 27 in the original</span>
<span class="sd">        ACE paper (doi.org/10.1103/PhysRevB.99.014104)</span>
<span class="sd">        Lengths have to be consistent between ace_included_expansion_ranks,</span>
<span class="sd">        ace_maximum_n_per_rank, ace_maximum_l_per_rank and</span>
<span class="sd">        ace_minimum_l_per_rank.</span>

<span class="sd">    ace_balance_cutoff_radii_for_elements : bool</span>
<span class="sd">        If True, cutoff radii will be balanced between element types.</span>
<span class="sd">        This is helpful when dealing with elements varying drastically in size.</span>

<span class="sd">    ace_larger_cutoff_for_metals : list</span>
<span class="sd">        If True (default) a slightly larger cutoff is used for metals. This</span>
<span class="sd">        is recommended.</span>

<span class="sd">    ace_use_maximum_cutoff_per_element : list</span>
<span class="sd">        If True, the maximum chemically reasonable cutoff will be used</span>
<span class="sd">        for all bonds. These maximum cutoff radii are based on the</span>
<span class="sd">        Van-der-Waals radii. Note that this may increase computation time!</span>

<span class="sd">    ace_coupling_coefficients_type : str</span>
<span class="sd">        Coupling type used for reduction of spherical harmonic products.</span>
<span class="sd">        These come into play starting from equation 28 in the original</span>
<span class="sd">        ACE paper (doi.org/10.1103/PhysRevB.99.014104).</span>
<span class="sd">        Can be &quot;clebsch_gordan&quot; or &quot;wigner_3j&quot;. This parameter usually does</span>
<span class="sd">        not have to be changed. The default is &quot;clebsch_gordan&quot;.</span>

<span class="sd">    ace_coupling_coefficients_maximum_l : int</span>
<span class="sd">        The maximum l up to which to precompute the Clebsch-Gordan/Wigner 3j</span>
<span class="sd">        symbols. These are precomputed within MALA to reduce overall</span>
<span class="sd">        computation time, but to save on storage space, precomputation is only</span>
<span class="sd">        done to a certain l (for the meaning of l, refer to the original ACE</span>
<span class="sd">        paper, doi.org/10.1103/PhysRevB.99.014104, page 5). MALA automatically</span>
<span class="sd">        recomputes the coefficients if ace_coupling_coefficients_maximum_l is</span>
<span class="sd">        increased.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersDescriptors</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptor_type</span> <span class="o">=</span> <span class="s2">&quot;Bispectrum&quot;</span>

        <span class="c1"># These affect all descriptors, at least as long all descriptors</span>
        <span class="c1"># use LAMMPS (which they currently do).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_lammps_compute_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors_contain_xyz</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO: I would rather handle the parallelization info automatically</span>
        <span class="c1"># and more under the hood. At this stage of the project this would</span>
        <span class="c1"># probably be overkill and hard to do, since there are many moving</span>
        <span class="c1"># parts, so for now let&#39;s keep this here, but in the future,</span>
        <span class="c1"># this should be adressed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_z_splitting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_y_splitting</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Everything pertaining to the bispectrum descriptors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bispectrum_twojmax</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bispectrum_cutoff</span> <span class="o">=</span> <span class="mf">4.67637</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bispectrum_switchflag</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Everything pertaining to the atomic density.</span>
        <span class="c1"># Seperate cutoff given here because bispectrum descriptors and</span>
        <span class="c1"># atomic density may be used at the same time, if e.g. bispectrum</span>
        <span class="c1"># descriptors are used for a full inference, which then uses the atomic</span>
        <span class="c1"># density for the calculation of the Ewald sum.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_density_sigma</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_density_cutoff</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Everything concerning the minterpy descriptors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minterpy_point_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minterpy_cutoff_cube_size</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minterpy_polynomial_degree</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minterpy_lp_norm</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="c1"># Everything pertaining to the ACE descriptors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_cutoff_factor</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="c1"># Many body orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_included_expansion_ranks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_maximum_n_per_rank</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_maximum_l_per_rank</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_minimum_l_per_rank</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Flavors/extra options for the ACE descriptors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_balance_cutoff_radii_for_elements</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_larger_cutoff_for_metals</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_use_maximum_cutoff_per_element</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Other value could be &quot;wigner3j&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_coupling_coefficients_type</span> <span class="o">=</span> <span class="s2">&quot;clebsch_gordan&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ace_coupling_coefficients_maximum_l</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_z_splitting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control whether splitting across the z-axis is used.</span>

<span class="sd">        Default is True, since this gives descriptors compatible with</span>
<span class="sd">        QE, for total energy evaluation. However, setting this value to False</span>
<span class="sd">        can, e.g. in the LAMMPS case, improve performance. This is relevant</span>
<span class="sd">        for e.g. preprocessing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_z_splitting</span>

    <span class="nd">@use_z_splitting</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_z_splitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_y_splitting</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_z_splitting</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_y_splitting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control whether a splitting in y-axis is used.</span>

<span class="sd">        This can only be used in conjunction with a z-splitting, and</span>
<span class="sd">        the option will ignored if z-splitting is disabled. Only has an</span>
<span class="sd">        effect for values larger then 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_y_planes</span>

    <span class="nd">@use_y_splitting</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_y_splitting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_z_splitting</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_y_planes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_number_y_planes</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_number_y_planes</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bispectrum_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cut off radius for bispectrum calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rcutfac</span>

    <span class="nd">@bispectrum_cutoff</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bispectrum_cutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcutfac</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atomic_density_cutoff</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ace_cutoff_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cutoff radius factor for ACE descriptor calculation.</span>

<span class="sd">        This is NOT a cutoff radius itself. Rather, ACE computes on cutoff</span>
<span class="sd">        radius for every bond between element types (with grid points counting</span>
<span class="sd">        as an element type). These cutoff radii are then multiplied by this</span>
<span class="sd">        factor to get the actual cutoff radii. This factor is a global factor,</span>
<span class="sd">        and by default 2.0. Chage it carefully, since changing it may lead to</span>
<span class="sd">        an increase in computation time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ace_cutoff</span>

    <span class="nd">@ace_cutoff_factor</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ace_cutoff_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">printout</span><span class="p">(</span>
                <span class="s2">&quot;ACE cutoff factor must be larger than 0.0, defaulting&quot;</span>
                <span class="s2">&quot; to 2.0.&quot;</span><span class="p">,</span>
                <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ace_cutoff</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ace_cutoff</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bispectrum_switchflag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switchflag for the bispectrum calculation.</span>

<span class="sd">        Can only be 1 or 0. If 1 (default), a switching function will be used</span>
<span class="sd">        to ensure that atomic contributions smoothly go to zero after a</span>
<span class="sd">        certain cutoff. If 0 (old default, which can be problematic in some</span>
<span class="sd">        instances), this is not done, which can lead to discontinuities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snap_switchflag</span>

    <span class="nd">@bispectrum_switchflag</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bispectrum_switchflag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">_int_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_int_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_switchflag</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">_int_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_snap_switchflag</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_mpi</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new MPI setting to parameter subclasses.</span>

<span class="sd">        Also deletes old inputs files that are no longer valid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_mpi : bool</span>
<span class="sd">            New MPI setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;mpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_mpi</span>

        <span class="c1"># There may have been a serial or parallel run before that is now</span>
        <span class="c1"># no longer valid.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_lammps_compute_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span></div>



<div class="viewcode-block" id="ParametersTargets">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersTargets">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersTargets</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters necessary for calculating/parsing output quantites.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    target_type : string</span>
<span class="sd">        Number of points in the energy grid that is used to calculate the</span>
<span class="sd">        (L)DOS.</span>

<span class="sd">    ldos_gridsize : int or list</span>
<span class="sd">        Gridsize of the LDOS. Can either be an int or a list of ints,</span>
<span class="sd">        in which case splitting of the (L)DOS along the energy axis is assumed.</span>
<span class="sd">        Note that this splitting feature is currently experimental and the</span>
<span class="sd">        interface may change in the future. Further, if this type of splitting</span>
<span class="sd">        is used, please make sure that ldos_gridsize, ldos_gridspacing_ev</span>
<span class="sd">        and ldos_gridoffset_ev are lists of the same length.</span>

<span class="sd">    ldos_gridspacing_ev: float or list</span>
<span class="sd">        Gridspacing of the energy grid the (L)DOS is evaluated on [eV].</span>
<span class="sd">        Can either be a float or a list of floats, in which case splitting of</span>
<span class="sd">        the (L)DOS along the energy axis is assumed.</span>
<span class="sd">        Note that this splitting feature is currently experimental and the</span>
<span class="sd">        interface may change in the future. Further, if this type of splitting</span>
<span class="sd">        is used, please make sure that ldos_gridsize, ldos_gridspacing_ev</span>
<span class="sd">        and ldos_gridoffset_ev are lists of the same length.</span>

<span class="sd">    ldos_gridoffset_ev: float or list</span>
<span class="sd">        Lowest energy value on the (L)DOS energy grid [eV].</span>
<span class="sd">        Can either be a float or a list of floats, in which case splitting of</span>
<span class="sd">        the (L)DOS along the energy axis is assumed.</span>
<span class="sd">        Note that this splitting feature is currently experimental and the</span>
<span class="sd">        interface may change in the future. Further, if this type of splitting</span>
<span class="sd">        is used, please make sure that ldos_gridsize, ldos_gridspacing_ev</span>
<span class="sd">        and ldos_gridoffset_ev are lists of the same length.</span>

<span class="sd">    pseudopotential_path : string</span>
<span class="sd">        Path at which pseudopotentials are located (for TEM).</span>

<span class="sd">    rdf_parameters : dict</span>
<span class="sd">        Parameters for calculating the radial distribution function(RDF).</span>
<span class="sd">        The RDF can directly be calculated via a function call, but if it is</span>
<span class="sd">        calculated e.g. during a MD or MC run, these parameters will control</span>
<span class="sd">        how. The following keywords are recognized:</span>

<span class="sd">        number_of_bins : int</span>
<span class="sd">            Number of bins used to create the histogram.</span>

<span class="sd">        rMax : float</span>
<span class="sd">            Radius up to which to calculate the RDF. None by default; this</span>
<span class="sd">            is the suggested behavior, as MALA will then on its own calculate</span>
<span class="sd">            the maximum radius up until which the calculation of the RDF is</span>
<span class="sd">            indisputably physically meaningful. Larger radii may be specified,</span>
<span class="sd">            e.g. for a Fourier transformation to calculate the static structure</span>
<span class="sd">            factor.</span>

<span class="sd">    tpcf_parameters : dict</span>
<span class="sd">        Parameters for calculating the three particle correlation function</span>
<span class="sd">        (TPCF).</span>
<span class="sd">        The TPCF can directly be calculated via a function call, but if it is</span>
<span class="sd">        calculated e.g. during a MD or MC run, these parameters will control</span>
<span class="sd">        how. The following keywords are recognized:</span>

<span class="sd">        number_of_bins : int</span>
<span class="sd">            Number of bins used to create the histogram.</span>

<span class="sd">        rMax : float</span>
<span class="sd">            Radius up to which to calculate the TPCF. If None, MALA will</span>
<span class="sd">            determine the maximum radius for which the TPCF is indisputably</span>
<span class="sd">            defined. Be advised - this may come at increased computational</span>
<span class="sd">            cost.</span>

<span class="sd">    ssf_parameters : dict</span>
<span class="sd">        Parameters for calculating the static structure factor</span>
<span class="sd">        (SSF).</span>
<span class="sd">        The SSF can directly be calculated via a function call, but if it is</span>
<span class="sd">        calculated e.g. during a MD or MC run, these parameters will control</span>
<span class="sd">        how. The following keywords are recognized:</span>

<span class="sd">        number_of_bins : int</span>
<span class="sd">            Number of bins used to create the histogram.</span>

<span class="sd">        kMax : float</span>
<span class="sd">            Maximum wave vector up to which to calculate the SSF.</span>

<span class="sd">    assume_two_dimensional : bool</span>
<span class="sd">        If True, the total energy calculations will be performed without</span>
<span class="sd">        periodic boundary conditions in z-direction, i.e., the cell will</span>
<span class="sd">        be truncated in the z-direction. NOTE: This parameter may be</span>
<span class="sd">        moved up to a global parameter, depending on whether descriptor</span>
<span class="sd">        calculation may benefit from it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersTargets</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_type</span> <span class="o">=</span> <span class="s2">&quot;LDOS&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldos_gridsize</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldos_gridspacing_ev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldos_gridoffset_ev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrict_targets</span> <span class="o">=</span> <span class="s2">&quot;zero_out_negative&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pseudopotential_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdf_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number_of_bins&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;rMax&quot;</span><span class="p">:</span> <span class="s2">&quot;mic&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tpcf_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number_of_bins&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;rMax&quot;</span><span class="p">:</span> <span class="s2">&quot;mic&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssf_parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;number_of_bins&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;kMax&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_two_dimensional</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">restrict_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control if and how targets are restricted to physical values.</span>

<span class="sd">        Can be &quot;zero_out_negative&quot;, i.e. all negative values are set to zero</span>
<span class="sd">        or &quot;absolute_values&quot;, i.e. all negative values are multiplied by -1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_targets</span>

    <span class="nd">@restrict_targets</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">restrict_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;zero_out_negative&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;absolute_values&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_targets</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restrict_targets</span> <span class="o">=</span> <span class="n">value</span></div>



<div class="viewcode-block" id="ParametersData">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersData</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters necessary for loading and preprocessing data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    snapshot_directories_list : list</span>
<span class="sd">        A list of all added snapshots.</span>

<span class="sd">    data_splitting_type : string</span>
<span class="sd">        Specify how the data for validation, test and training is splitted.</span>
<span class="sd">        Currently the only supported option is by_snapshot,</span>
<span class="sd">        which splits the data by snapshot boundaries. It is also the default.</span>

<span class="sd">    input_rescaling_type : string</span>
<span class="sd">        Specifies how input quantities are normalized.</span>
<span class="sd">        Options:</span>

<span class="sd">            - &quot;None&quot;: No scaling is applied.</span>
<span class="sd">            - &quot;standard&quot;: Standardization (Scale to mean 0,</span>
<span class="sd">              standard deviation 1) is applied to the entire array.</span>
<span class="sd">            - &quot;minmax&quot;: Min-Max scaling (Scale to be in range 0...1) is applied</span>
<span class="sd">              to the entire array.</span>
<span class="sd">            - &quot;feature-wise-standard&quot;: Standardization (Scale to mean 0,</span>
<span class="sd">              standard deviation 1) is applied to each feature dimension</span>
<span class="sd">              individually.</span>
<span class="sd">              I.e., if your training data has dimensions (d,f), then each</span>
<span class="sd">              of the f columns with d entries is scaled indiviually.</span>
<span class="sd">            - &quot;feature-wise-minmax&quot;: Min-Max scaling (Scale to be in range</span>
<span class="sd">              0...1) is applied to each feature dimension individually.</span>
<span class="sd">              I.e., if your training data has dimensions (d,f), then each</span>
<span class="sd">              of the f columns with d entries is scaled indiviually.</span>
<span class="sd">            - &quot;normal&quot;: (DEPRECATED) Old name for &quot;minmax&quot;.</span>
<span class="sd">            - &quot;feature-wise-normal&quot;: (DEPRECATED) Old name for</span>
<span class="sd">              &quot;feature-wise-minmax&quot;</span>

<span class="sd">    output_rescaling_type : string</span>
<span class="sd">        Specifies how output quantities are normalized.</span>
<span class="sd">        Options:</span>

<span class="sd">            - &quot;None&quot;: No scaling is applied.</span>
<span class="sd">            - &quot;standard&quot;: Standardization (Scale to mean 0,</span>
<span class="sd">              standard deviation 1) is applied to the entire array.</span>
<span class="sd">            - &quot;minmax&quot;: Min-Max scaling (Scale to be in range 0...1) is applied</span>
<span class="sd">              to the entire array.</span>
<span class="sd">            - &quot;feature-wise-standard&quot;: Standardization (Scale to mean 0,</span>
<span class="sd">              standard deviation 1) is applied to each feature dimension</span>
<span class="sd">              individually.</span>
<span class="sd">              I.e., if your training data has dimensions (d,f), then each</span>
<span class="sd">              of the f columns with d entries is scaled indiviually.</span>
<span class="sd">            - &quot;feature-wise-minmax&quot;: Min-Max scaling (Scale to be in range</span>
<span class="sd">              0...1) is applied to each feature dimension individually.</span>
<span class="sd">              I.e., if your training data has dimensions (d,f), then each</span>
<span class="sd">              of the f columns with d entries is scaled indiviually.</span>
<span class="sd">            - &quot;normal&quot;: (DEPRECATED) Old name for &quot;minmax&quot;.</span>
<span class="sd">            - &quot;feature-wise-normal&quot;: (DEPRECATED) Old name for</span>
<span class="sd">              &quot;feature-wise-minmax&quot;</span>

<span class="sd">    use_lazy_loading : bool</span>
<span class="sd">        If True, data is lazily loaded, i.e. only the snapshots that are</span>
<span class="sd">        currently needed will be kept in memory. This greatly reduces memory</span>
<span class="sd">        demands, but adds additional computational time.</span>

<span class="sd">    use_lazy_loading_prefetch : bool</span>
<span class="sd">        If True, will use alternative lazy loading path with prefetching</span>
<span class="sd">        for higher performance</span>

<span class="sd">    use_fast_tensor_data_set : bool</span>
<span class="sd">        If True, then the new, fast TensorDataSet implemented by Josh Romero</span>
<span class="sd">        will be used.</span>

<span class="sd">    shuffling_seed : int</span>
<span class="sd">        If not None, a seed that will be used to make the shuffling of the data</span>
<span class="sd">        in the DataShuffler class deterministic.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot_directories_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_splitting_type</span> <span class="o">=</span> <span class="s2">&quot;by_snapshot&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_rescaling_type</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_rescaling_type</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_lazy_loading</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_lazy_loading_prefetch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_fast_tensor_data_set</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffling_seed</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="ParametersRunning">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersRunning">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersRunning</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters needed for network runs (train, test or inference).</span>

<span class="sd">    Some of these parameters only apply to either the train or test or</span>
<span class="sd">    inference case.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    optimizer : string</span>
<span class="sd">        Optimizer to be used. Supported options at the moment:</span>
<span class="sd">            - SGD: Stochastic gradient descent.</span>
<span class="sd">            - Adam: Adam Optimization Algorithm</span>

<span class="sd">    learning_rate : float</span>
<span class="sd">        Learning rate for chosen optimization algorithm. Default: 0.5.</span>

<span class="sd">    max_number_epochs : int</span>
<span class="sd">        Maximum number of epochs to train for. Default: 100.</span>

<span class="sd">    mini_batch_size : int</span>
<span class="sd">        Size of the mini batch for the optimization algorihm. Default: 10.</span>

<span class="sd">    early_stopping_epochs : int</span>
<span class="sd">        Number of epochs the validation accuracy is allowed to not improve by</span>
<span class="sd">        at leastearly_stopping_threshold, before we terminate. If 0, no</span>
<span class="sd">        early stopping is performed. Default: 0.</span>

<span class="sd">    early_stopping_threshold : float</span>
<span class="sd">        Minimum fractional reduction in validation loss required to avoid</span>
<span class="sd">        early stopping, e.g. a value of 0.05 means that validation loss must</span>
<span class="sd">        decrease by 5% within early_stopping_epochs epochs or the training</span>
<span class="sd">        will be stopped early. More explicitly,</span>
<span class="sd">        validation_loss &lt; validation_loss_old * (1-early_stopping_threshold)</span>
<span class="sd">        or the patience counter goes up.</span>
<span class="sd">        Default: 0. Numbers bigger than 0 can make early stopping very</span>
<span class="sd">        aggresive, while numbers less than 0 make the trainer very forgiving</span>
<span class="sd">        of loss increase.</span>

<span class="sd">    learning_rate_scheduler : string</span>
<span class="sd">        Learning rate scheduler to be used. If not None, an instance of the</span>
<span class="sd">        corresponding pytorch class will be used to manage the learning rate</span>
<span class="sd">        schedule.</span>
<span class="sd">        Options:</span>

<span class="sd">            - None: No learning rate schedule will be used.</span>
<span class="sd">            - &quot;ReduceLROnPlateau&quot;: The learning rate will be reduced when the</span>
<span class="sd">              validation loss is plateauing.</span>

<span class="sd">    learning_rate_decay : float</span>
<span class="sd">        Decay rate to be used in the learning rate (if the chosen scheduler</span>
<span class="sd">        supports that).</span>
<span class="sd">        Default: 0.1</span>

<span class="sd">    learning_rate_patience : int</span>
<span class="sd">        Patience parameter used in the learning rate schedule (how long the</span>
<span class="sd">        validation loss has to plateau before the schedule takes effect).</span>
<span class="sd">        Default: 0.</span>

<span class="sd">    num_workers : int</span>
<span class="sd">        Number of workers to be used for data loading.</span>

<span class="sd">    use_shuffling_for_samplers :</span>
<span class="sd">        If True, the training data will be shuffled in between epochs.</span>
<span class="sd">        If lazy loading is selected, then this shuffling will be done on</span>
<span class="sd">        a &quot;by snapshot&quot; basis.</span>

<span class="sd">    checkpoints_each_epoch : int</span>
<span class="sd">        If not 0, checkpoint files will be saved after each</span>
<span class="sd">        checkpoints_each_epoch epoch.</span>

<span class="sd">    checkpoint_name : string</span>
<span class="sd">        Name used for the checkpoints. Using this, multiple runs</span>
<span class="sd">        can be performed in the same directory.</span>

<span class="sd">    checkpoint_path : string</span>
<span class="sd">        Path where the checkpoints will be saved (and loaded from)</span>

<span class="sd">    run_name : string</span>
<span class="sd">        Name of the run used for logging.</span>

<span class="sd">    logging_dir : string</span>
<span class="sd">        Name of the folder that logging files will be saved to.</span>

<span class="sd">    logging_dir_append_date : bool</span>
<span class="sd">        If True, then upon creating logging files, these will be saved</span>
<span class="sd">        in a subfolder of logging_dir labelled with the starting date</span>
<span class="sd">        of the logging, to avoid having to change input scripts often.</span>

<span class="sd">    logger : string</span>
<span class="sd">        Name of the logger to be used.</span>
<span class="sd">        Currently supported are:</span>

<span class="sd">            - &quot;tensorboard&quot;: Tensorboard logger.</span>
<span class="sd">            - &quot;wandb&quot;: Weights and Biases logger.</span>

<span class="sd">    validation_metrics : list</span>
<span class="sd">        List of metrics to be used for validation. Default is [&quot;ldos&quot;].</span>
<span class="sd">        Possible options are:</span>

<span class="sd">            - &quot;ldos&quot;: MSE of the LDOS.</span>
<span class="sd">            - &quot;band_energy&quot;: Band energy.</span>
<span class="sd">            - &quot;band_energy_actual_fe&quot;: Band energy computed with ground truth Fermi energy.</span>
<span class="sd">            - &quot;total_energy&quot;: Total energy.</span>
<span class="sd">            - &quot;total_energy_actual_fe&quot;: Total energy computed with ground truth Fermi energy.</span>
<span class="sd">            - &quot;fermi_energy&quot;: Fermi energy.</span>
<span class="sd">            - &quot;density&quot;: Electron density.</span>
<span class="sd">            - &quot;density_relative&quot;: Rlectron density (MAPE).</span>
<span class="sd">            - &quot;dos&quot;: Density of states.</span>
<span class="sd">            - &quot;dos_relative&quot;: Density of states (MAPE).</span>

<span class="sd">    validate_on_training_data : bool</span>
<span class="sd">        Whether to validate on the training data as well. Default is False.</span>

<span class="sd">    validate_every_n_epochs : int</span>
<span class="sd">        Determines how often validation is performed. Default is 1.</span>

<span class="sd">    training_log_interval : int</span>
<span class="sd">        Determines how often detailed performance info is printed during</span>
<span class="sd">        training (only has an effect if the verbosity is high enough).</span>

<span class="sd">    profiler_range : list</span>
<span class="sd">        List with two entries determining with which batch/iteration number</span>
<span class="sd">         the CUDA profiler will start and stop profiling. Please note that</span>
<span class="sd">         this option only holds significance if the nsys profiler is used.</span>

<span class="sd">    inference_data_grid : list</span>
<span class="sd">        Grid dimensions used during inference. Typically, these are automatically</span>
<span class="sd">        determined by DFT reference data, and this parameter does not need to</span>
<span class="sd">        be set. Thus, this parameter mainly exists for debugging purposes.</span>

<span class="sd">    use_mixed_precision : bool</span>
<span class="sd">        If True, mixed precision computation (via AMP) will be used.</span>

<span class="sd">    l2_regularization : float</span>
<span class="sd">        Weight decay rate for NN optimizer.</span>

<span class="sd">    dropout : float</span>
<span class="sd">        Dropout rate for positional encoding in transformer net.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersRunning</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="s2">&quot;Adam&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1"># self.learning_rate_embedding = 10 ** (-4)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_number_epochs</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># self.snapshots_per_epoch = -1</span>

        <span class="c1"># self.l1_regularization = 0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_regularization</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># self.batch_norm = False</span>
        <span class="c1"># self.input_noise = 0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_epochs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">early_stopping_threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_decay</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learning_rate_patience</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_during_training_metric</span> <span class="o">=</span> <span class="s2">&quot;ldos&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_training_metric</span> <span class="o">=</span> <span class="s2">&quot;ldos&quot;</span>
        <span class="c1"># self.use_compression = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_shuffling_for_samplers</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoints_each_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># self.checkpoint_best_so_far = False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_name</span> <span class="o">=</span> <span class="s2">&quot;checkpoint_mala&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_path</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_dir</span> <span class="o">=</span> <span class="s2">&quot;./mala_logging&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_dir_append_date</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ldos&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_on_training_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_every_n_epochs</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_data_grid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mixed_precision</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_graphs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">training_log_interval</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ddp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagate new DDP setting to parameter subclasses.</span>

<span class="sd">        Also ensures only metrics are used which work with DDP.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        new_ddp : bool</span>
<span class="sd">            New DDP setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersRunning</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="n">new_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">during_training_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">during_training_metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_training_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_training_metric</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">during_training_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control the metric used during training.</span>

<span class="sd">        Metric for evaluated on the validation set during training.</span>
<span class="sd">        Default is &quot;ldos&quot;, meaning that the regular loss on the LDOS will be</span>
<span class="sd">        used as a metric. Possible options are &quot;band_energy&quot; and</span>
<span class="sd">        &quot;total_energy&quot;. For these, the band resp. total energy of the</span>
<span class="sd">        validation snapshots will be calculated and compared to the provided</span>
<span class="sd">        DFT results. Of these, the mean average error in eV/atom will be</span>
<span class="sd">        calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_during_training_metric</span>

    <span class="nd">@during_training_metric</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">during_training_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;ldos&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;ddp&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Currently, MALA can only operate with the &quot;</span>
                    <span class="s1">&#39;&quot;ldos&quot; metric for ddp runs.&#39;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">validation_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_during_training_metric</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">after_training_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the metric used during training.</span>

<span class="sd">        Metric for evaluated on the validation and test set before and after</span>
<span class="sd">        training. Default is &quot;LDOS&quot;, meaning that the regular loss on the LDOS</span>
<span class="sd">        will be used as a metric. Possible options are &quot;band_energy&quot; and</span>
<span class="sd">        &quot;total_energy&quot;. For these, the band resp. total energy of the</span>
<span class="sd">        validation snapshots will be calculated and compared to the provided</span>
<span class="sd">        DFT results. Of these, the mean average error in eV/atom will be</span>
<span class="sd">        calculated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_training_metric</span>

    <span class="nd">@after_training_metric</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">after_training_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;ldos&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;ddp&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;Currently, MALA can only operate with the &quot;</span>
                    <span class="s1">&#39;&quot;ldos&quot; metric for ddp runs.&#39;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_training_metric</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide whether CUDA graphs are used during training.</span>

<span class="sd">        Doing so will improve performance, but CUDA graphs are only available</span>
<span class="sd">        from CUDA 11.0 upwards.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_graphs</span>

    <span class="nd">@use_graphs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_graphs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_configuration</span><span class="p">[</span><span class="s2">&quot;gpu&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
                <span class="ow">or</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">parallel_warn</span><span class="p">(</span><span class="s2">&quot;No CUDA or GPU found, cannot use CUDA graphs.&quot;</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">11.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot use CUDA graphs with a CUDA&quot;</span>
                        <span class="s2">&quot; version below 11.0&quot;</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_graphs</span> <span class="o">=</span> <span class="n">value</span></div>



<div class="viewcode-block" id="ParametersHyperparameterOptimization">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersHyperparameterOptimization">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersHyperparameterOptimization</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hyperparameter optimization parameters.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    direction : string</span>
<span class="sd">        Controls whether to minimize or maximize the loss function.</span>
<span class="sd">        Arguments are &quot;minimize&quot; and &quot;maximize&quot; respectively.</span>

<span class="sd">    n_trials : int</span>
<span class="sd">        Controls how many trials are performed (when using optuna).</span>
<span class="sd">        Default: 100.</span>

<span class="sd">    hlist : list</span>
<span class="sd">        List containing hyperparameters, that are then passed to optuna.</span>
<span class="sd">        Supported options so far include:</span>

<span class="sd">            - learning_rate (float): learning rate of the training algorithm</span>
<span class="sd">            - layer_activation_xxx (categorical): Activation function used for</span>
<span class="sd">              the feed forward network (see Netwok  parameters for supported</span>
<span class="sd">              activation functions). Note that _xxx is only so that optuna</span>
<span class="sd">              will differentiate between variables. No reordering is</span>
<span class="sd">              performed by the; the order depends on the order in the</span>
<span class="sd">              list. _xxx can be essentially anything. Please note further</span>
<span class="sd">              that you need to either only request one acitvation function</span>
<span class="sd">              (for all layers) or one for specifically for each layer.</span>
<span class="sd">            - ff_neurons_layer_xxx(int): Number of neurons per a layer. Note</span>
<span class="sd">              that _xxx is only so that optuna will differentiate between</span>
<span class="sd">              variables. No reordering is performed by MALA; the order</span>
<span class="sd">              depends on the order in the list. _xxx can be essentially</span>
<span class="sd">              anything.</span>

<span class="sd">        Users normally don&#39;t have to fill this list by hand, the hyperparamer</span>
<span class="sd">        optimizer provide interfaces for this task.</span>


<span class="sd">    hyper_opt_method : string</span>
<span class="sd">        Method used for hyperparameter optimization. Currently supported:</span>

<span class="sd">            - &quot;optuna&quot; : Use optuna for the hyperparameter optimization.</span>
<span class="sd">            - &quot;oat&quot; : Use orthogonal array tuning (currently limited to</span>
<span class="sd">              categorical hyperparemeters). Range analysis is</span>
<span class="sd">              currently done by simply choosing the lowest loss.</span>
<span class="sd">            - &quot;naswot&quot; : Using a NAS without training, based on jacobians.</span>

<span class="sd">    checkpoints_each_trial : int</span>
<span class="sd">        If not 0, checkpoint files will be saved after each</span>
<span class="sd">        checkpoints_each_trial trials. Currently, this only works with</span>
<span class="sd">        optuna.</span>

<span class="sd">    checkpoint_name : string</span>
<span class="sd">        Name used for the checkpoints. Using this, multiple runs</span>
<span class="sd">        can be performed in the same directory. Currently. this</span>
<span class="sd">        only works with optuna.</span>

<span class="sd">    study_name : string</span>
<span class="sd">        Name used for this study (in optuna#s storage). Necessary</span>
<span class="sd">        when operating with a RDB storage.</span>

<span class="sd">    rdb_storage : string</span>
<span class="sd">        Adress of the RDB storage to be used by optuna.</span>

<span class="sd">    rdb_storage_heartbeat : int</span>
<span class="sd">        Heartbeat interval for optuna (in seconds). Default is None.</span>
<span class="sd">        If not None and above 0, optuna will record the heartbeat of intervals.</span>
<span class="sd">        If no action on a RUNNING trial is recognized for longer then this</span>
<span class="sd">        interval, then this trial will be moved to FAILED. In distributed</span>
<span class="sd">        training, setting a heartbeat is currently the only way to achieve</span>
<span class="sd">        a precise number of trials:</span>

<span class="sd">        https://github.com/optuna/optuna/issues/1883</span>

<span class="sd">        For optuna versions below 2.8.0, larger heartbeat intervals are</span>
<span class="sd">        detrimental to performance and should be avoided:</span>

<span class="sd">        https://github.com/optuna/optuna/issues/2685</span>

<span class="sd">        For MALA, no evidence for decreased performance using smaller</span>
<span class="sd">        heartbeat values could be found. So if this is used, 1s is a reasonable</span>
<span class="sd">        value.</span>

<span class="sd">    number_training_per_trial : int</span>
<span class="sd">        Number of network trainings performed per trial. Default is 1,</span>
<span class="sd">        but it makes sense to choose a higher number, to exclude networks</span>
<span class="sd">        that performed by chance (good initilization). Naturally this impedes</span>
<span class="sd">        performance.</span>

<span class="sd">    trial_ensemble_evaluation : string</span>
<span class="sd">        Control how multiple trainings performed during a trial are evaluated.</span>
<span class="sd">        By default, simply &quot;mean&quot; is used. For smaller numbers of training</span>
<span class="sd">        per trial it might make sense to use &quot;mean_std&quot;, which means that</span>
<span class="sd">        the mean of all metrics plus the standard deviation is used,</span>
<span class="sd">        as an estimate of the minimal accuracy to be expected. Currently,</span>
<span class="sd">        &quot;mean&quot; and &quot;mean_std&quot; are allowed.</span>

<span class="sd">    use_multivariate : bool</span>
<span class="sd">        If True, the optuna multivariate sampler is used. It is experimental</span>
<span class="sd">        since v2.2.0, but reported to perform very well.</span>
<span class="sd">        http://proceedings.mlr.press/v80/falkner18a.html</span>

<span class="sd">    naswot_pruner_cutoff : float</span>
<span class="sd">        If the surrogate loss algorithm is used as a pruner during a study,</span>
<span class="sd">        this cutoff determines which trials are neglected.</span>

<span class="sd">    pruner: string</span>
<span class="sd">        Pruner type to be used by optuna. Currently supported:</span>

<span class="sd">            - &quot;multi_training&quot;: If multiple trainings are performed per</span>
<span class="sd">              trial, and one returns &quot;inf&quot; for the loss,</span>
<span class="sd">              no further training will be performed.</span>
<span class="sd">              Especially useful if used in conjunction</span>
<span class="sd">              with the band_energy metric.</span>
<span class="sd">            - &quot;naswot&quot;: use the NASWOT algorithm as pruner</span>

<span class="sd">    naswot_pruner_batch_size : int</span>
<span class="sd">        Batch size for the NASWOT pruner</span>

<span class="sd">    number_bad_trials_before_stopping : int</span>
<span class="sd">        Only applies to optuna studies. If any integer above 0, then if no</span>
<span class="sd">        new best trial is found within number_bad_trials_before trials after</span>
<span class="sd">        the last one, the study will be stopped.</span>

<span class="sd">    sqlite_timeout : int</span>
<span class="sd">        Timeout for the SQLite backend of Optuna. This backend is officially</span>
<span class="sd">        not recommended because it is file based and can lead to errors;</span>
<span class="sd">        With a suitable timeout it can be used somewhat stable though and</span>
<span class="sd">        help in HPC settings.</span>

<span class="sd">    acsd_points : int</span>
<span class="sd">        Parameter of the ACSD HyperparamterOptimization scheme. Controls</span>
<span class="sd">        the number of point-pairs which are used to compute the ACSD.</span>
<span class="sd">        An array of acsd_points*acsd_points will be computed, i.e., if</span>
<span class="sd">        acsd_points=100, 100 points will be drawn at random, and thereafter</span>
<span class="sd">        each of these 100 points will be compared with a new, random set</span>
<span class="sd">        of 100 points, leading to 10000 points in total for the calculation</span>
<span class="sd">        of the ACSD.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersHyperparameterOptimization</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;minimize&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyper_opt_method</span> <span class="o">=</span> <span class="s2">&quot;optuna&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoints_each_trial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_name</span> <span class="o">=</span> <span class="s2">&quot;checkpoint_mala_ho&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">study_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdb_storage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rdb_storage_heartbeat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_training_per_trial</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_ensemble_evaluation</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_multivariate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naswot_pruner_cutoff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pruner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">naswot_pruner_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_bad_trials_before_stopping</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlite_timeout</span> <span class="o">=</span> <span class="mi">600</span>

        <span class="c1"># For accelerated hyperparameter optimization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acsd_points</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutual_information_points</span> <span class="o">=</span> <span class="mi">20000</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rdb_storage_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether a heartbeat is used for distributed optuna runs.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rdb_storage_heartbeat</span>

    <span class="nd">@rdb_storage_heartbeat</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rdb_storage_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdb_storage_heartbeat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rdb_storage_heartbeat</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_training_per_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control how many trainings are run per optuna trial.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_training_per_trial</span>

    <span class="nd">@number_training_per_trial</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">number_training_per_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_training_per_trial</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_number_training_per_trial</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trial_ensemble_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control how multiple trainings performed during a trial are evaluated.</span>

<span class="sd">        By default, simply &quot;mean&quot; is used. For smaller numbers of training</span>
<span class="sd">        per trial it might make sense to use &quot;mean_std&quot;, which means that</span>
<span class="sd">        the mean of all metrics plus the standard deviation is used,</span>
<span class="sd">        as an estimate of the minimal accuracy to be expected. Currently,</span>
<span class="sd">        &quot;mean&quot; and &quot;mean_std&quot; are allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trial_ensemble_evaluation</span>

    <span class="nd">@trial_ensemble_evaluation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">trial_ensemble_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s2">&quot;mean_std&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trial_ensemble_evaluation</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trial_ensemble_evaluation</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="ParametersHyperparameterOptimization.show">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersHyperparameterOptimization.show">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print name and values of all attributes of this object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        indent : string</span>
<span class="sd">            The indent used in the list with which the parameter</span>
<span class="sd">            shows itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;_configuration&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="s2">&quot;hlist&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                        <span class="n">printout</span><span class="p">(</span>
                            <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span>
                            <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">printout</span><span class="p">(</span>
                            <span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span>
                            <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="s2">&quot;hlist&quot;</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">hyp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlist</span><span class="p">:</span>
                        <span class="n">printout</span><span class="p">(</span>
                            <span class="n">indent</span>
                            <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;hyperparameter #&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">hyp</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                            <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>
</div>



<div class="viewcode-block" id="ParametersDataGeneration">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.ParametersDataGeneration">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ParametersDataGeneration</span><span class="p">(</span><span class="n">ParametersBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All parameters to help with data generation.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    trajectory_analysis_denoising_width : int</span>
<span class="sd">        The distance metric is denoised prior to analysis using a certain</span>
<span class="sd">        width. This should be adjusted if there is reason to believe</span>
<span class="sd">        the trajectory will be noise for some reason.</span>

<span class="sd">    trajectory_analysis_below_average_counter : int</span>
<span class="sd">        Number of time steps that have to consecutively below the average</span>
<span class="sd">        of the distance metric curve, before we consider the trajectory</span>
<span class="sd">        to be equilibrated.</span>
<span class="sd">        Usually does not have to be changed.</span>

<span class="sd">    trajectory_analysis_estimated_equilibrium : float</span>
<span class="sd">        The analysis of the trajectory builds on the assumption that at some</span>
<span class="sd">        point of the trajectory, the system is equilibrated.</span>
<span class="sd">        For this, we need to provide the fraction of the trajectory (counted</span>
<span class="sd">        from the end). Usually, 10% is a fine assumption. This value usually</span>
<span class="sd">        does not need to be changed.</span>

<span class="sd">    trajectory_analysis_correlation_metric_cutoff : float</span>
<span class="sd">        Cutoff value to be used when sampling uncorrelated snapshots</span>
<span class="sd">        during trajectory analysis. If negative, a value will be determined</span>
<span class="sd">        numerically. This value is a cutoff for the minimum euclidean distance</span>
<span class="sd">        between any two ions in two subsequent ionic configurations.</span>

<span class="sd">    trajectory_analysis_temperature_tolerance_percent : float</span>
<span class="sd">        Maximum deviation of temperature between snapshot and desired</span>
<span class="sd">        temperature for snapshot to be considered for DFT calculation</span>
<span class="sd">        (in percent)</span>

<span class="sd">    local_psp_path : string</span>
<span class="sd">        Path to where the local pseudopotential is stored (for OF-DFT-MD).</span>

<span class="sd">    local_psp_name : string</span>
<span class="sd">        Name of the local pseudopotential (for OF-DFT-MD).</span>

<span class="sd">    ofdft_timestep : int</span>
<span class="sd">        Timestep of the OF-DFT-MD simulation.</span>

<span class="sd">    ofdft_number_of_timesteps : int</span>
<span class="sd">        Number of timesteps for the OF-DFT-MD simulation.</span>

<span class="sd">    ofdft_temperature : float</span>
<span class="sd">        Temperature at which to perform the OF-DFT-MD simulation.</span>

<span class="sd">    ofdft_kedf : string</span>
<span class="sd">        Kinetic energy functional to be used for the OF-DFT-MD simulation.</span>

<span class="sd">    ofdft_friction : float</span>
<span class="sd">        Friction to be added for the Langevin dynamics in the OF-DFT-MD run.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParametersDataGeneration</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_analysis_denoising_width</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_analysis_below_average_counter</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_analysis_estimated_equilibrium</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_analysis_correlation_metric_cutoff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trajectory_analysis_temperature_tolerance_percent</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_psp_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_psp_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofdft_timestep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofdft_number_of_timesteps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofdft_temperature</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofdft_kedf</span> <span class="o">=</span> <span class="s2">&quot;WT&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ofdft_friction</span> <span class="o">=</span> <span class="mf">0.1</span></div>



<div class="viewcode-block" id="Parameters">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Parameters</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    All parameter MALA needs to perform its various tasks.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    comment : string</span>
<span class="sd">        Characterizes a set of parameters (e.g. &quot;experiment_ddmmyy&quot;).</span>

<span class="sd">    network : ParametersNetwork</span>
<span class="sd">        Contains all parameters necessary for constructing a neural network.</span>

<span class="sd">    descriptors : ParametersDescriptors</span>
<span class="sd">        Contains all parameters necessary for calculating/parsing descriptors.</span>

<span class="sd">    targets : ParametersTargets</span>
<span class="sd">        Contains all parameters necessary for calculating/parsing output</span>
<span class="sd">        quantites.</span>

<span class="sd">    data : ParametersData</span>
<span class="sd">        Contains all parameters necessary for loading and preprocessing data.</span>

<span class="sd">    running : ParametersRunning</span>
<span class="sd">        Contains parameters needed for network runs (train, test or inference).</span>

<span class="sd">    hyperparameters : ParametersHyperparameterOptimization</span>
<span class="sd">        Parameters used for hyperparameter optimization.</span>

<span class="sd">    manual_seed: int</span>
<span class="sd">        If not none, this value is used as manual seed for the neural networks.</span>
<span class="sd">        Can be used to make experiments comparable. Default: None.</span>

<span class="sd">    datageneration : ParametersDataGeneration</span>
<span class="sd">        Parameters used for data generation routines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Parameters subobjects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">ParametersNetwork</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">ParametersDescriptors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">ParametersTargets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ParametersData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="n">ParametersRunning</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span> <span class="o">=</span> <span class="n">ParametersHyperparameterOptimization</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datageneration</span> <span class="o">=</span> <span class="n">ParametersDataGeneration</span><span class="p">()</span>

        <span class="c1"># Attributes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manual_seed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># TODO: Maybe as a percentage? Feature dimensions can be quite</span>
        <span class="c1"># different.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openpmd_granularity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adjust the memory overhead of the OpenPMD interface.</span>

<span class="sd">        Smallest possible value is 1, meaning smallest memory footprint</span>
<span class="sd">        and slowest I/O. Higher values will introduce some memory penalty,</span>
<span class="sd">        but offer greater speed.</span>
<span class="sd">        The maximum level is the feature dimension of your data set, if</span>
<span class="sd">        you choose a value larger than this feature dimension, it will</span>
<span class="sd">        automatically be set to the feature dimension upon loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span>

    <span class="nd">@openpmd_granularity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_openpmd_granularity</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_granularity</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Control the level of output for MALA.</span>

<span class="sd">        The following options are available:</span>

<span class="sd">            - 0: &quot;low&quot;, only essential output will be printed</span>
<span class="sd">            - 1: &quot;medium&quot;, most diagnostic output will be printed. (Default)</span>
<span class="sd">            - 2: &quot;high&quot;, all information will be printed.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span>

    <span class="nd">@verbosity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">set_current_verbosity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether a GPU is used (provided there is one).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_gpu</span>

    <span class="nd">@use_gpu</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_gpu</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_use_gpu</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parallel_warn</span><span class="p">(</span>
                    <span class="s2">&quot;GPU requested, but no GPU found. MALA will &quot;</span>
                    <span class="s2">&quot;operate with CPU only.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">:</span>
            <span class="n">printout</span><span class="p">(</span>
                <span class="s2">&quot;Enabling atomic density formula because LAMMPS and GPU &quot;</span>
                <span class="s2">&quot;are used.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Invalidate, will be updated in setter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_gpu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_ddp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether ddp is used for parallel training.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_ddp</span>

    <span class="nd">@use_ddp</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_ddp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing torch.distributed.&quot;</span><span class="p">)</span>
            <span class="c1"># JOSHR:</span>
            <span class="c1"># We start up torch distributed here. As is fairly standard</span>
            <span class="c1"># convention, we get the rank and world size arguments via</span>
            <span class="c1"># environment variables (RANK, WORLD_SIZE). In addition to</span>
            <span class="c1"># those variables, LOCAL_RANK, MASTER_ADDR and MASTER_PORT</span>
            <span class="c1"># should be set.</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RANK&quot;</span><span class="p">))</span>
            <span class="n">world_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;WORLD_SIZE&quot;</span><span class="p">))</span>

            <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="s2">&quot;nccl&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>

        <span class="n">set_ddp_status</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># Invalidate, will be updated in setter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_ddp</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_ddp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_ddp</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the device used by MALA. Read-only.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device</span>

    <span class="nd">@device</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">get_local_rank</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="s2">&quot;cuda:&quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">device_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_device</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether MPI is used for paralle inference.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_mpi</span>

    <span class="nd">@use_mpi</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_mpi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">set_mpi_status</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># Invalidate, will be updated in setter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_mpi</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_mpi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provide a .toml or .json formatted string to configure OpenPMD.</span>

<span class="sd">        To load a configuration from a file, add an &quot;@&quot; in front of the file</span>
<span class="sd">        name and put the resulting string here. OpenPMD will then load</span>
<span class="sd">        the file. For further details, see the OpenPMD documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_configuration</span>

    <span class="nd">@openpmd_configuration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_openpmd_configuration</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_openpmd_configuration</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">openpmd_configuration</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether to use LAMMPS for descriptor calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_lammps</span>

    <span class="nd">@use_lammps</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_lammps</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">printout</span><span class="p">(</span>
                <span class="s2">&quot;Enabling atomic density formula because LAMMPS and GPU &quot;</span>
                <span class="s2">&quot;are used.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_lammps</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_atomic_density_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Control whether to use the atomic density formula.</span>

<span class="sd">        This formula uses as a Gaussian representation of the atomic density</span>
<span class="sd">        to calculate the structure factor and with it, the Ewald energy</span>
<span class="sd">        and parts of the exchange-correlation energy. By using it, one can</span>
<span class="sd">        go from N^2 to NlogN scaling, and offloads most of the computational</span>
<span class="sd">        overhead of energy calculation from QE to LAMMPS. This is beneficial</span>
<span class="sd">        since LAMMPS can benefit from GPU acceleration (QE GPU acceleration</span>
<span class="sd">        is not used in the portion of the QE code MALA employs). If set</span>
<span class="sd">        to True, this means MALA will perform another LAMMPS calculation</span>
<span class="sd">        during inference. The hyperparameters for this atomic density</span>
<span class="sd">        calculation are set via the parameters.descriptors object.</span>
<span class="sd">        Default is False, except for when both use_gpu and use_lammps</span>
<span class="sd">        are True, in which case this value will be set to True as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_atomic_density_formula</span>

    <span class="nd">@use_atomic_density_formula</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">use_atomic_density_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_atomic_density_formula</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_atomic_density_formula</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Parameters.show">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.show">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print name and values of all attributes of this object.&quot;&quot;&quot;</span>
        <span class="n">printout</span><span class="p">(</span>
            <span class="s2">&quot;--- &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ---&quot;</span><span class="p">,</span> <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>

        <span class="c1"># Two for-statements so that global parameters are shown on top.</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">ParametersBase</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                    <span class="n">printout</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span>
                        <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printout</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%-15s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)),</span> <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span>
                    <span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">ParametersBase</span><span class="p">):</span>
                <span class="n">parobject</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">printout</span><span class="p">(</span>
                    <span class="s2">&quot;--- &quot;</span> <span class="o">+</span> <span class="n">parobject</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ---&quot;</span><span class="p">,</span>
                    <span class="n">min_verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">parobject</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.save">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Parameters object to a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        save_format : string</span>
<span class="sd">            File format which is used for parameter saving.</span>
<span class="sd">            Currently only supported file format is &quot;pickle&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_rank</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">save_format</span> <span class="o">==</span> <span class="s2">&quot;pickle&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;pkl&quot;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.pkl&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">save_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;.json&quot;</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="p">)</span>

            <span class="c1"># Two for loops so global properties enter the dict first.</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="c1"># Filter out all private members, builtins, etc.</span>
                <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span> <span class="ow">and</span> <span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;device&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ParametersBase</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="c1"># Filter out all private members, builtins, etc.</span>
                <span class="k">if</span> <span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ParametersBase</span><span class="p">):</span>
                        <span class="c1"># All the subclasses have to provide this function.</span>
                        <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">ParametersBase</span>  <span class="c1"># type: ignore</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">member</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported parameter save format.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.save_as_pickle">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.save_as_pickle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Parameters object to a pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;pickle&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.save_as_json">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.save_as_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Parameters object to a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : string</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.optuna_singlenode_setup">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.optuna_singlenode_setup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">optuna_singlenode_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up device and parallelization parameters for Optuna+MPI.</span>

<span class="sd">        This only needs to be called if multiple MPI ranks are used on</span>
<span class="sd">        one node to run Optuna. Optuna itself does NOT communicate via MPI.</span>
<span class="sd">        Thus, if we allocate e.g. one node with 4 GPUs and start 4 jobs,</span>
<span class="sd">        3 of those jobs will fail, because currently, we instantiate the</span>
<span class="sd">        cuda devices based on MPI ranks. This functions sets everything</span>
<span class="sd">        up properly. This of course requires MPI.</span>
<span class="sd">        This may be a bit hacky, but it lets us use one script and one</span>
<span class="sd">        MPI command to launch x GPU backed jobs on any node with x GPUs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wait_time : int</span>
<span class="sd">            If larger than 0, then all processes will wait this many seconds</span>
<span class="sd">            times their rank number after this routine before proceeding.</span>
<span class="sd">            This can be useful when using a file based distribution algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We first &quot;trick&quot; the parameters object to assume MPI and GPUs</span>
        <span class="c1"># are used. That way we get the right device.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">device_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span>
        <span class="n">sleep</span><span class="p">(</span><span class="n">get_rank</span><span class="p">()</span> <span class="o">*</span> <span class="n">wait_time</span><span class="p">)</span>

        <span class="c1"># Now we can turn of MPI and set the device manually.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_mpi</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_device</span> <span class="o">=</span> <span class="n">device_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparameters</span><span class="o">.</span><span class="n">_update_device</span><span class="p">(</span><span class="n">device_temp</span><span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.load_from_file">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.load_from_file">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_file</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">no_snapshots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_no_ddp</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a Parameters object from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : string or ZipExtFile</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        save_format : string</span>
<span class="sd">            File format which is used for parameter saving.</span>
<span class="sd">            Currently only supported file format is &quot;pickle&quot;.</span>

<span class="sd">        no_snapshots : bool</span>
<span class="sd">            If True, than the snapshot list will be emptied. Useful when</span>
<span class="sd">            performing inference/testing after training a network.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loaded_parameters : Parameters</span>
<span class="sd">            The loaded Parameters object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">save_format</span> <span class="o">==</span> <span class="s2">&quot;pickle&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">loaded_parameters</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loaded_parameters</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">no_snapshots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">loaded_parameters</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">snapshot_directories_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">save_format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

            <span class="n">loaded_parameters</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;openpmd_configuration&quot;</span>
                <span class="p">):</span>
                    <span class="c1"># These are the other parameter classes.</span>
                    <span class="n">sub_parameters</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span>
                        <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;_parameters_type&quot;</span><span class="p">]</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">loaded_parameters</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sub_parameters</span><span class="p">)</span>

                    <span class="c1"># Backwards compatability:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;descriptors&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="s2">&quot;use_atomic_density_energy_formula&quot;</span>
                            <span class="ow">in</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="n">loaded_parameters</span><span class="o">.</span><span class="n">use_atomic_density_formula</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span>
                                    <span class="s2">&quot;use_atomic_density_energy_formula&quot;</span>
                                <span class="p">]</span>
                            <span class="p">)</span>

            <span class="c1"># We iterate a second time, to set global values, so that they</span>
            <span class="c1"># are properly forwarded.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;openpmd_configuration&quot;</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;use_ddp&quot;</span> <span class="ow">and</span> <span class="n">force_no_ddp</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">loaded_parameters</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">loaded_parameters</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">no_snapshots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">loaded_parameters</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">snapshot_directories_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Backwards compatability: since the transfer of old property</span>
            <span class="c1"># to new property happens _before_ all children descriptor classes</span>
            <span class="c1"># are instantiated, it is not properly propagated. Thus, we</span>
            <span class="c1"># simply have to set it to its own value again.</span>
            <span class="n">loaded_parameters</span><span class="o">.</span><span class="n">use_atomic_density_formula</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">loaded_parameters</span><span class="o">.</span><span class="n">use_atomic_density_formula</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported parameter save format.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loaded_parameters</span></div>


<div class="viewcode-block" id="Parameters.load_from_pickle">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.load_from_pickle">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">no_snapshots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a Parameters object from a pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : string or ZipExtFile</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        no_snapshots : bool</span>
<span class="sd">            If True, than the snapshot list will be emptied. Useful when</span>
<span class="sd">            performing inference/testing after training a network.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loaded_parameters : Parameters</span>
<span class="sd">            The loaded Parameters object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span>
            <span class="n">file</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;pickle&quot;</span><span class="p">,</span> <span class="n">no_snapshots</span><span class="o">=</span><span class="n">no_snapshots</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Parameters.load_from_json">
<a class="viewcode-back" href="../../../api/mala.common.parameters.html#mala.common.parameters.Parameters.load_from_json">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">no_snapshots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_no_ddp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a Parameters object from a json file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : string or ZipExtFile</span>
<span class="sd">            File to which the parameters will be saved to.</span>

<span class="sd">        no_snapshots : bool</span>
<span class="sd">            If True, than the snapshot list will be emptied. Useful when</span>
<span class="sd">            performing inference/testing after training a network.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        loaded_parameters : Parameters</span>
<span class="sd">            The loaded Parameters object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Parameters</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span>
            <span class="n">file</span><span class="p">,</span>
            <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="n">no_snapshots</span><span class="o">=</span><span class="n">no_snapshots</span><span class="p">,</span>
            <span class="n">force_no_ddp</span><span class="o">=</span><span class="n">force_no_ddp</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software. Attila Cangi, J. Austin Ellis, Lenz Fiedler, Daniel Kotik, Normand Modine, Sivasankaran Rajamanickam, Steve Schmerler, Aidan Thompson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>